"use client";

import { useEffect, useState } from "react";

const STORAGE_KEY = "gf_investimentos_v1";
const COINGECKO_API = "https://api.coingecko.com/api/v3/simple/price";

export default function InvestimentosPage() {
  const [ativos, setAtivos] = useState([]);
  const [form, setForm] = useState({
    tipo: "cripto",
    simbolo: "",
    nome: "",
    quantidade: "",
    precoMedio: "",
    cor: "#22c55e",
  });
  const [totais, setTotais] = useState({
    valorAtual: 0,
    custoTotal: 0,
    plNaoRealizado: 0,
  });

  // === Carrega investimentos do LocalStorage ===
  useEffect(() => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) setAtivos(JSON.parse(raw));
    } catch {}
  }, []);

  // === Atualiza preços das criptos automaticamente ===
  useEffect(() => {
    const criptos = ativos.filter((a) => a.tipo === "cripto");
    if (criptos.length === 0) return;

    const ids = criptos.map((a) => a.simbolo.toLowerCase()).join(",");
    fetch(`${COINGECKO_API}?ids=${ids}&vs_currencies=eur`)
      .then((r) => r.json())
      .then((data) => {
        const atualizados = ativos.map((a) => {
          if (a.tipo !== "cripto") return a;
          const price =
            data[a.simbolo.toLowerCase()]?.eur || a.precoAtual || 0;
          return { ...a, precoAtual: price };
        });
        setAtivos(atualizados);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(atualizados));
      })
      .catch(() => {});
  }, [ativos.length]);

  // === Calcula totais gerais ===
  useEffect(() => {
    const valorAtual = ativos.reduce(
      (s, a) => s + a.quantidade * (a.precoAtual || a.precoMedio || 0),
      0
    );
    const custoTotal = ativos.reduce(
      (s, a) => s + a.quantidade * (a.precoMedio || 0),
      0
    );
    const plNaoRealizado = valorAtual - custoTotal;
    setTotais({ valorAtual, custoTotal, plNaoRealizado });
  }, [ativos]);

  // === Adicionar ativo ===
  function addAtivo(e) {
    e.preventDefault();
    const novo = {
      id: Math.random().toString(36).slice(2),
      tipo: form.tipo,
      simbolo: form.simbolo.trim(),
      nome: form.nome.trim(),
      quantidade: Number(form.quantidade || 0),
      precoMedio: Number(form.precoMedio || 0),
      precoAtual: 0,
      cor: form.cor || "#22c55e",
    };
    const prox = [...ativos, novo];
    setAtivos(prox);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(prox));
    setForm({
      tipo: "cripto",
      simbolo: "",
      nome: "",
      quantidade: "",
      precoMedio: "",
      cor: "#22c55e",
    });
  }

  // === Excluir ativo ===
  function deleteAtivo(id) {
    if (!confirm("Excluir este ativo?")) return;
    const prox = ativos.filter((a) => a.id !== id);
    setAtivos(prox);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(prox));
  }

  // === Formatador de moeda ===
  const fmt = (n) =>
    Number(n || 0).toLocaleString("pt-PT", {
      style: "currency",
      currency: "EUR",
    });

  return (
    <div style={styles.container}>
      <h1 style={styles.title}>Investimentos</h1>

      {/* === Totais === */}
      <div style={styles.summary}>
        <div>
          <div style={styles.label}>Valor atual</div>
          <div style={styles.value}>{fmt(totais.valorAtual)}</div>
        </div>
        <div>
          <div style={styles.label}>Custo total</div>
          <div style={styles.value}>{fmt(totais.custoTotal)}</div>
        </div>
        <div>
          <div style={styles.label}>P/L não realizado</div>
          <div
            style={{
              ...styles.value,
              color: totais.plNaoRealizado >= 0 ? "#16a34a" : "#b91c1c",
            }}
          >
            {fmt(totais.plNaoRealizado)} (
            {((totais.plNaoRealizado / (totais.custoTotal || 1)) * 100).toFixed(
              2
            )}
            %)
          </div>
        </div>
      </div>

      {/* === Grid principal === */}
      <div style={styles.grid}>
        {/* === Carteira === */}
        <div style={styles.card}>
          <table style={styles.table}>
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Ativo</th>
                <th>Qtd</th>
                <th>Preço Méd.</th>
                <th>Preço Atual</th>
                <th>Valor Atual</th>
                <th>P/L</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {ativos.length === 0 ? (
                <tr>
                  <td colSpan={8} style={{ textAlign: "center", opacity: 0.6 }}>
                    Nenhum investimento adicionado.
                  </td>
                </tr>
              ) : (
                ativos.map((a) => {
                  const valorAtual =
                    a.quantidade * (a.precoAtual || a.precoMedio || 0);
                  const custo = a.quantidade * (a.precoMedio || 0);
                  const pl = valorAtual - custo;
                  const plPct = (pl / (custo || 1)) * 100;
                  return (
                    <tr key={a.id}>
                      <td>
                        <span
                          style={{
                            display: "inline-block",
                            width: 10,
                            height: 10,
                            borderRadius: "50%",
                            background: a.cor,
                            marginRight: 6,
                          }}
                        ></span>
                        {a.tipo}
                      </td>
                      <td>{a.simbolo.toUpperCase()}</td>
                      <td>{a.quantidade}</td>
                      <td>{fmt(a.precoMedio)}</td>
                      <td>{fmt(a.precoAtual || a.precoMedio)}</td>
                      <td>{fmt(valorAtual)}</td>
                      <td
                        style={{
                          color: pl >= 0 ? "#15803d" : "#b91c1c",
                          fontWeight: 600,
                        }}
                      >
                        {fmt(pl)} ({plPct.toFixed(2)}%)
                      </td>
                      <td>
                        <button
                          style={styles.btnDelete}
                          onClick={() => deleteAtivo(a.id)}
                        >
                          Excluir
                        </button>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>

        {/* === Formulário === */}
        <form style={styles.cardForm} onSubmit={addAtivo}>
          <h3 style={styles.formTitle}>Adicionar ativo</h3>

          <div style={styles.radioGroup}>
            <label>
              <input
                type="radio"
                name="tipo"
                value="cripto"
                checked={form.tipo === "cripto"}
                onChange={(e) => setForm({ ...form, tipo: e.target.value })}
              />
              Cripto
            </label>
            <label>
              <input
                type="radio"
                name="tipo"
                value="acao"
                checked={form.tipo === "acao"}
                onChange={(e) => setForm({ ...form, tipo: e.target.value })}
              />
              Ação
            </label>
            <label>
              <input
                type="radio"
                name="tipo"
                value="outro"
                checked={form.tipo === "outro"}
                onChange={(e) => setForm({ ...form, tipo: e.target.value })}
              />
              Outro
            </label>
          </div>

          <input
            placeholder="Símbolo (ex: BTC, AAPL)"
            value={form.simbolo}
            onChange={(e) => setForm({ ...form, simbolo: e.target.value })}
            required
            style={styles.input}
          />
          <input
            placeholder="Nome (opcional)"
            value={form.nome}
            onChange={(e) => setForm({ ...form, nome: e.target.value })}
            style={styles.input}
          />
          <input
            placeholder="Quantidade"
            type="number"
            value={form.quantidade}
            onChange={(e) => setForm({ ...form, quantidade: e.target.value })}
            required
            style={styles.input}
          />
          <input
            placeholder="Preço médio (€)"
            type="number"
            value={form.precoMedio}
            onChange={(e) => setForm({ ...form, precoMedio: e.target.value })}
            required
            style={styles.input}
          />
          <div style={styles.colorBox}>
            <span>Cor:</span>
            <input
              type="color"
              value={form.cor}
              onChange={(e) => setForm({ ...form, cor: e.target.value })}
            />
          </div>

          <button type="submit" style={styles.btnSave}>
            Salvar
          </button>
        </form>
      </div>
    </div>
  );
}

/* === Estilos inline (substitui investimentos.css) === */
const styles = {
  container: { padding: 24, color: "#111" },
  title: { fontSize: 26, fontWeight: 700, marginBottom: 18 },
  summary: {
    display: "flex",
    gap: 30,
    marginBottom: 20,
    flexWrap: "wrap",
  },
  label: { fontSize: 13, opacity: 0.7 },
  value: { fontSize: 17, fontWeight: 600 },
  grid: {
    display: "grid",
    gridTemplateColumns: "1.3fr 0.8fr",
    gap: 18,
    alignItems: "start",
  },
  card: {
    background: "#fff",
    border: "1px solid #e5e7eb",
    borderRadius: 12,
    padding: 14,
    boxShadow: "0 1px 2px rgba(0,0,0,.05)",
  },
  table: {
    width: "100%",
    borderCollapse: "collapse",
    fontSize: 14,
  },
  cardForm: {
    background: "#fff",
    border: "1px solid #e5e7eb",
    borderRadius: 12,
    padding: 16,
    textAlign: "center",
  },
  formTitle: { fontWeight: 700, fontSize: 16, marginBottom: 10 },
  radioGroup: {
    display: "flex",
    justifyContent: "center",
    gap: 20,
    marginBottom: 12,
  },
  input: {
    width: "100%",
    height: 34,
    padding: "0 10px",
    borderRadius: 8,
    border: "1px solid #e5e7eb",
    marginBottom: 8,
  },
  colorBox: {
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    gap: 8,
    margin: "8px 0",
  },
  btnSave: {
    width: "100%",
    background: "#2563eb",
    color: "#fff",
    border: "none",
    borderRadius: 8,
    padding: "8px 0",
    cursor: "pointer",
  },
  btnDelete: {
    background: "#fee2e2",
    color: "#991b1b",
    border: "1px solid #fecaca",
    borderRadius: 6,
    padding: "4px 8px",
    cursor: "pointer",
  },
};
